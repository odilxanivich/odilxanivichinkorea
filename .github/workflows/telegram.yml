name: New MD â†’ Telegram

on:
  push:
    branches: [ main ]
    paths: [ '**.md' ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Find new .md files
        id: files
        run: |
          git fetch --depth=2
          NEW_MD=$(git diff --diff-filter=A --name-only HEAD~1 | grep '\.md$' || true)
          echo "new_md<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_MD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found: $NEW_MD"
      
      - name: Send to Telegram
        if: steps.files.outputs.new_md != ''
        run: |
          while read file; do
            TITLE=$(sed -n 's/^title: *"\(.*\)"/\1/p' "$file")
            SUMMARY=$(sed -n 's/^summary: *"\(.*\)"/\1/p' "$file")
            MSG="ðŸ†• ${TITLE}\n\n${SUMMARY}"
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MSG"
          done <<< "${{ steps.files.outputs.new_md }}"
