name: Send new post summary to Telegram

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.commits != null }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find newly added markdown files
        id: new_files
        run: |
          git diff --diff-filter=A --name-only ${{ github.event.before }} ${{ github.sha }} | grep ".md$" > new_files.txt || true
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat new_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Prepare and send message
        if: ${{ steps.new_files.outputs.files != '' }}
        run: |
          while read file; do
            if [ -f "$file" ]; then
              TITLE=$(grep '^title:' "$file" | sed 's/title:[[:space:]]*"\(.*\)"/\1/')
              SUMMARY=$(grep '^summary:' "$file" | sed 's/summary:[[:space:]]*"\(.*\)"/\1/')
              MESSAGE="ðŸ†• *Yangi post:* ${TITLE}\n\n${SUMMARY}"
              echo "Sending: $MESSAGE"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                -d parse_mode="Markdown" \
                -d text="$MESSAGE"
            fi
          done < new_files.txt
