name: Notify Telegram on Markdown Push

on:
  push:
    paths:
      - '**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Collect commit info and changed files
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | grep '.md' || true)
          TITLE=$(git log -1 --pretty=%s)
          DESC=$(git log -1 --pretty=%b)

          echo "FILES=$FILES" >> $GITHUB_ENV
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "DESC=$DESC" >> $GITHUB_ENV

      - name: Debug values
        run: |
          echo "FILES=${{ env.FILES }}"
          echo "TITLE=${{ env.TITLE }}"
          echo "DESC=${{ env.DESC }}"

      - name: Send Telegram message
        run: |
          for f in ${{ env.FILES }}; do
            RESPONSE=$(curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d parse_mode=HTML \
              -d text="ğŸ”¥ <b>Yangi post qoâ€˜shildi!</b><br><br>ğŸ“„ <b>Fayl:</b> $f<br>ğŸ“ <b>Sarlavha:</b> ${{ env.TITLE }}<br>ğŸ’¡ <i>Izoh:</i> ${{ env.DESC }}<br><br>ğŸ‘‰ <a href='https://odilxanivichinkorea.com/posts/$f'>Postni koâ€˜rish</a>")
            echo "Telegram API response: $RESPONSE"
          done
