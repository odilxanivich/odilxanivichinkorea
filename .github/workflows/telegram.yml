name: Notify Telegram on Markdown Push

on:
  push:
    paths:
      - '**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install gray-matter

      - name: Extract front-matter with Node.js
        id: parse
        run: |
          FILE=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.md$' | head -n 1)
          if [ -z "$FILE" ]; then
            echo "title=Yangi post" >> $GITHUB_OUTPUT
            echo "desc=Yangi maqola qoâ€˜shildi" >> $GITHUB_OUTPUT
            exit 0
          fi

          node -e "
          const fs = require('fs');
          const matter = require('gray-matter');
          const file = process.env.FILE;
          const content = fs.readFileSync(file, 'utf8');
          const data = matter(content).data;
          const title = data.title || 'Yangi post';
          const desc = data.excerpt || data.summary || 'Yangi maqola qoâ€˜shildi';
          console.log('title=' + title);
          console.log('desc=' + desc);
          " >> $GITHUB_OUTPUT
        env:
          FILE: ${{ github.event.head_commit.id }}

      - name: Send Telegram message
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode=HTML \
            -d text="ğŸ”¥ Yangi post qoâ€˜shildi!%0A%0AğŸ“ Sarlavha: ${{ steps.parse.outputs.title }}%0AğŸ’¡ Tavsif: ${{ steps.parse.outputs.desc }}"